<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babylon.js Village </title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.js"></script>
    <script src="https://cdn.babylonjs.com/serializers/babylon.glTFSerializer.js"></script>
</head>
<body>
    <canvas id="renderCanvas" style="width: 100%; height: 100%;"></canvas>
    <button id="downloadButton" style="position: absolute; top: 20px; left: 20px; z-index: 10;">Download Stickman GLB</button>
    
    <script>
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);

        const createScene = function () {
            const scene = new BABYLON.Scene(engine);
            
            // Camera Animation
            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 3, 20, new BABYLON.Vector3(0, 0, 0));
            camera.attachControl(canvas, true);
            scene.onBeforeRenderObservable.add(() => {
                camera.alpha += 0.002; // Smooth panning
            });

            // Lighting with Day-Night Cycle
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0));
            let lightIntensity = 0;
            let lightDirection = 0.01;
            scene.onBeforeRenderObservable.add(() => {
                lightIntensity += lightDirection;
                if (lightIntensity >= 1 || lightIntensity <= 0) lightDirection *= -1;
                light.intensity = lightIntensity;
            });

            // Village and Character
            BABYLON.SceneLoader.ImportMeshAsync("", "https://assets.babylonjs.com/meshes/", "village.glb");
            let dude;
            BABYLON.SceneLoader.ImportMeshAsync("him", "./", "Dude3.babylon", scene).then((result) => {
                dude = result.meshes[0];
                dude.scaling = new BABYLON.Vector3(0.012, 0.012, 0.012);
                dude.position = new BABYLON.Vector3(-6, 0, 0);
                scene.beginAnimation(result.skeletons[0], 0, 100, true, 1.0);
            });

            // Interactive Character Movement
            window.addEventListener("keydown", (e) => {
                if (dude) {
                    if (e.key === "w") dude.position.z += 0.5;
                    if (e.key === "s") dude.position.z -= 0.5;
                    if (e.key === "a") dude.position.x -= 0.5;
                    if (e.key === "d") dude.position.x += 0.5;
                }
            });

            // Jumping Spheres with Gravity
            const spheres = [];
            const sphereProps = [{ color: new BABYLON.Color3(1, 0, 0), pos: new BABYLON.Vector3(0, 0, 6) },
                                 { color: new BABYLON.Color3(0, 1, 0), pos: new BABYLON.Vector3(0, 2, 0) },
                                 { color: new BABYLON.Color3(0, 0, 1), pos: new BABYLON.Vector3(2, 0, 0) }];
            sphereProps.forEach((props) => {
                const sphere = BABYLON.MeshBuilder.CreateSphere("sphere", { diameter: 0.5, segments: 32 }, scene);
                sphere.position = props.pos;
                sphere.material = new BABYLON.StandardMaterial("material", scene);
                sphere.material.diffuseColor = props.color;
                spheres.push(sphere);
            });

            let jumpDirection = 0.05;
            scene.onBeforeRenderObservable.add(() => {
                spheres.forEach((sphere) => {
                    sphere.position.y += jumpDirection;
                    if (sphere.position.y > 2 || sphere.position.y < 0) jumpDirection *= -1;
                });
            });

            // Particle Effects (Dust Trail) Behind the Character
            const dustParticles = new BABYLON.ParticleSystem("dustParticles", 2000, scene);
            dustParticles.particleTexture = new BABYLON.Texture("https://www.babylonjs-playground.com/textures/flare.png", scene);
            dustParticles.emitter = dude;
            dustParticles.minEmitBox = new BABYLON.Vector3(-1, 0, 1);
            dustParticles.maxEmitBox = new BABYLON.Vector3(1, 0, -1);
            dustParticles.color1 = new BABYLON.Color4(0.7, 0.7, 0.7, 1.0);
            dustParticles.color2 = new BABYLON.Color4(0.5, 0.5, 0.5, 1.0);
            dustParticles.minSize = 0.05;
            dustParticles.maxSize = 0.1;
            dustParticles.minLifeTime = 0.3;
            dustParticles.maxLifeTime = 1.5;
            dustParticles.emitRate = 500;
            dustParticles.start();

            return scene;
        };

        var scene = createScene();
        engine.runRenderLoop(function () {
            scene.render();
        });

        window.addEventListener("resize", function () {
            engine.resize();
        });

        // Function to export as GLB
        function exportToGLB() {
            BABYLON.GLTF2Export.GLBAsync(scene, "stickman.glb").then((glb) => {
                glb.downloadFiles();
            });
        }

        // Attach export function to the download button
        document.getElementById("downloadButton").addEventListener("click", exportToGLB);
    </script>
</body>
</html>
